<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paket- und Einschreiben-Sortierung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html {}
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh; 
            overflow-y: auto; 
            overflow-x: hidden; 
        }
        .main-container {
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            padding-left: 0.5rem; 
            padding-right: 0.5rem;
        }
        @media (min-width: 640px) { /* sm */
            .main-container { max-width: 640px; padding-left: 1rem; padding-right: 1rem; }
        }
        @media (min-width: 768px) { /* md */
            .main-container { max-width: 768px; padding-left: 1.5rem; padding-right: 1.5rem; }
        }
        @media (min-width: 1024px) { /* lg */
            .main-container { max-width: 1024px; }
        }

        .top-controls-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #ffffff;
            padding: 0.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px -1px rgba(0,0,0,0.06), 0 1px 2px -1px rgba(0,0,0,0.04);
            margin-bottom: 1rem;
        }
        .top-controls-bar .btn, .top-controls-bar select {
            height: 2.5rem; 
            font-size: 0.875rem; 
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }
        .top-controls-bar .btn {
             flex-shrink: 0; 
        }
        .top-controls-bar .btn-icon-text { 
            min-width: 50px; /* Adjusted for icon */
            padding-left: 0.5rem; /* Adjust padding for icon buttons */
            padding-right: 0.5rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .top-controls-bar .btn-icon-text svg {
            width: 1.25em; /* 20px if font-size is 16px */
            height: 1.25em;
        }
        .top-controls-bar .select-district-container {
            flex-grow: 1;
            margin-left: 0.5rem;
            margin-right: 0.5rem;
            min-width: 120px; 
        }
        .top-controls-bar select {
            width: 100%;
        }
        
        .filter-bar-container {
            position: -webkit-sticky; 
            position: sticky;
            top: 0; 
            background-color: #f0f2f5; 
            padding-top: 0.5rem; 
            padding-bottom: 0.5rem;
            z-index: 100; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            margin-bottom: 0.5rem; 
        }
        .filter-buttons {
            display: flex; 
            overflow-x: auto; 
            white-space: nowrap; 
            -webkit-overflow-scrolling: touch; 
            background-color: #ffffff;
            padding: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px -1px rgba(0,0,0,0.08), 0 1px 2px -1px rgba(0,0,0,0.04);
        }
        .filter-buttons::-webkit-scrollbar { display: none; }
        .filter-buttons { scrollbar-width: thin; scrollbar-color: #d1d5db #f0f2f5; }

        .filter-btn {
            display: inline-block; 
            padding: 0.375rem 0.625rem; 
            margin-right: 0.5rem; 
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            border: 1px solid #d1d5db; 
            background-color: #ffffff; 
            color: #374151; 
            cursor: pointer;
            font-size: 0.75rem; 
            line-height: 1.25; 
            text-align: center; 
            flex-shrink: 0; 
        }
        .filter-btn:last-child { margin-right: 0; }
        .filter-btn:hover { background-color: #f3f4f6; }
        .filter-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .filter-btn.disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; border-color: #d1d5db;}
        .filter-btn span { 
            background-color: rgba(0,0,0,0.05); padding: 0.1rem 0.3rem; 
            border-radius: 0.25rem; margin-left: 0.25rem; font-weight: 600;
            font-size: 0.7rem; 
        }
        .filter-btn.active span { background-color: rgba(255,255,255,0.2); }

        .item-card-compact {
            background-color: #ffffff; border-radius: 0.5rem; padding: 0.5rem; 
            margin-bottom: 0.5rem; 
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); 
            display: flex; align-items: center; border-left: 4px solid; 
            position: relative; /* For drag handle positioning */
        }
        .item-card-compact.dragging { /* Style for the item being dragged */
            opacity: 0.5;
            background-color: #e0e7ff; /* Light blue */
        }
        .item-card-compact.drag-over-target { /* Style for item being hovered over during drag */
            border-top: 2px dashed #3b82f6;
        }

        .item-drag-handle {
            display: none; /* Hidden by default */
            position: absolute;
            left: -28px; /* Position to the left of the card */
            top: 50%;
            transform: translateY(-50%);
            cursor: grab;
            color: #6b7280; /* Gray-500 */
            padding: 0.25rem;
        }
        .item-drag-handle svg {
            width: 16px;
            height: 16px;
        }
        .reorder-mode .item-drag-handle {
            display: inline-flex; /* Show in reorder mode */
        }
        .reorder-mode .item-card-compact {
            padding-left: 1.75rem; /* Make space for the handle */
        }


        .item-card-teil-a { border-left-color: #3b82f6; }
        .item-card-teil-b { border-left-color: #10b981; }
        .item-part-type {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding-right: 0.5rem; border-right: 1px solid #e5e7eb; margin-right: 0.5rem; 
            min-width: 40px; flex-shrink: 0; 
        }
        .item-teil-compact { font-size: 1rem; font-weight: 700; color: #1f2937; } 
        .item-art-compact {
            font-size: 0.75rem; font-weight: 600; color: #4b5563; background-color: #e5e7eb; 
            padding: 0.1rem 0.3rem; border-radius: 0.25rem; margin-top: 0.2rem;
        }
        .item-info-compact { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        .item-address-compact { 
            font-size: 0.875rem; font-weight: 500; color: #1f2937; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .item-recipient-compact { 
            font-size: 0.875rem; color: #4b5563; margin-top: 0.1rem; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .item-id-compact { 
            font-size: 0.75rem; 
            color: #6b7280; 
            margin-top: 0.25rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .item-icons-compact { display: flex; flex-direction: column; align-items: center; padding-left: 0.5rem; flex-shrink: 0; }
        .icon-display {
            width: 20px; height: 20px; display: inline-flex; 
            align-items: center; justify-content: center; border-radius: 0.25rem;
            margin-bottom: 0.25rem; 
            fill: #9ca3af; 
            background-color: #f9fafb; 
            border: 1px solid #e5e7eb;
            cursor: pointer; 
        }
        .icon-display svg { 
            width: 12px; 
            height: 12px;
        }
        .icon-display:last-child { margin-bottom: 0; }
        .icon-display.active { 
            fill: #1d4ed8; 
            background-color: #eff6ff; 
            border-color: #bfdbfe; 
        }
        .icon-display.no-info { 
            cursor: default;
        }

        .btn {
            padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-weight: 500;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s; 
            border: 1px solid transparent;
            font-size: 0.875rem; line-height: 1.25rem; 
        }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; border-color: #d1d5db; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-secondary.active { /* Active state for manual reorder button */
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .btn-disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; }
        select {
            padding: 0.5rem 0.75rem; border-radius: 0.5rem;
            border: 1px solid #d1d5db; background-color: white;
            font-size: 0.875rem; width: 100%; 
            line-height: 1.25rem; 
            height: calc(0.5rem * 2 + 1.25rem + 2px); 
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: white; padding: 1.5rem; border-radius: 0.75rem; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            width: 90%; max-width: 500px; position: relative;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; 
        }
        .modal-title { font-size: 1.125rem; font-weight: 600; color: #1f2937; }
        .modal-close-btn {
            background: none; border: none; font-size: 1.5rem; font-weight: bold;
            color: #6b7280; cursor: pointer; padding: 0.25rem; line-height: 1;
        }
        .modal-close-btn:hover { color: #1f2937; }
        .modal-body { font-size: 0.875rem; color: #374151; line-height: 1.6; }
        .modal-body strong { font-weight: 600; color: #111827; }
        .modal-body .placeholder-text { color: #9ca3af; font-style: italic; }
        .modal-body hr { margin-top: 0.75rem; margin-bottom: 0.75rem; border-color: #e5e7eb; }
        .modal-body .info-text { color: #374151; }
        .modal-body .info-block { margin-bottom: 0.5rem; }
        .modal-body .info-block:last-child { margin-bottom: 0; }
    </style>
</head>
<body class="pt-4 pb-4"> 
    <div class="main-container mx-auto"> 
        
        <div class="top-controls-bar">
            <button id="abSortButton" class="btn btn-primary btn-icon-text">A/B</button>
            <button id="manualOrderButton" class="btn btn-secondary btn-icon-text" title="Manuell sortieren">
                <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5">
                    <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="select-district-container">
                <select id="districtSelect" aria-label="Bezirk auswählen"> 
                </select>
            </div>
        </div>

        <div id="filterBarContainer" class="filter-bar-container">
            <div class="filter-buttons">
                <button id="filterPakete" class="filter-btn" data-type-group="Pakete">
                    Pakete <span id="countPakete">0</span>
                </button>
                <button id="filterEinschreiben" class="filter-btn" data-type-group="Einschreiben">
                    Einschreiben <span id="countEinschreiben">0</span>
                </button>
                <button id="filterAbholauftraege" class="filter-btn disabled" data-type-group="Abholauftrag">
                    Abholaufträge <span id="countAbholauftraege">0</span>
                </button>
            </div>
        </div>

        <div id="itemsListContainer"> 
             <div id="itemsList" class="mt-0"> 
             </div>
        </div>
    </div>

    <div id="infoModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" class="modal-title">Information</h3>
                <button id="modalCloseBtn" class="modal-close-btn" aria-label="Schließen">&times;</button>
            </div>
            <div id="modalBodyContent" class="modal-body">
            </div>
        </div>
    </div>

    <script>
        // --- Data Generation ---
        const generatedItems = [];
        let itemIdCounter = 100000; 

        const sampleDistricts = ["Bezirk 1", "Bezirk 2", "Bezirk 3"];
        const sampleParts = ["A", "B"];
        const allItemTypes = ["Paket", "Kleinpaket", "Päckchen", "Einschreiben", "Einschreiben Einwurf", "Einschreiben Rückschein"];
        
        const sampleStreetData = {
            "Bezirk 1": {
                "A": ["Hauptstr.", "Kirchgasse", "Sonnenweg"],
                "B": ["Waldallee", "Bergpfad", "Seeblickstr."]
            },
            "Bezirk 2": {
                "A": ["Industriering", "Technologiepark", "Innovationspfad"],
                "B": ["Gartenstr.", "Blumenweg", "Rosenhang"]
            },
            "Bezirk 3": {
                "A": ["Altstadtgasse", "Marktplatz", "Burgsteig"],
                "B": ["Uferpromenade", "Flussblick", "Brückenweg"]
            }
        };

        const sampleLastNames = ["Müller", "Schmidt", "Schneider", "Fischer", "Weber", "Meyer", "Wagner", "Becker", "Schulz", "Hoffmann", "Koch", "Bauer", "Richter", "Klein", "Wolf", "Schröder", "Neumann", "Schwarz", "Zimmermann", "Braun", "Hartmann", "Lange", "Krause", "Werner", "Schmid"];
        const sampleFirstNames = ["Anna", "Paul", "Lisa", "Max", "Tim", "Sara", "Jan", "Eva", "Ben", "Tom", "Ina", "Lena", "Dirk", "Maria", "Sven", "Laura", "Erik", "Julia", "Karl", "Sandra", "Peter", "Monika", "Klaus", "Sabine", "Michael", "Petra", "Leon", "Sophie", "Finn", "Mia"];
        
        const sampleAblageorte = ["Garage", "Hinter der Mülltonne", "Unter der Treppe", "Vor der Haustür (überdacht)", "Paketkasten Code 1234", "Im Gartenhaus, Schlüssel unter Stein", "Auf der Terrasse, hinter Pflanze", "Balkon (1. OG), bitte hochwerfen", "", "Nur persönliche Übergabe erwünscht"];
        
        const sampleWunschnachbarDetails = [
            { name: "Meier, Klaus", adresse: "Hauptstr. 12 (Nebenan)", zusatz: "Bitte bis 19 Uhr klingeln." },
            { name: "Schulz, Petra", adresse: "Gegenüber, Nr. 7", zusatz: "Ist fast immer zu Hause." },
            { name: "Familie Huber", adresse: "Im selben Haus, EG links", zusatz: "" }, 
            { name: "Wagner, Tom", adresse: "Blumenweg 5", zusatz: "Nimmt Pakete für das ganze Haus an." },
            { name: "Kein spezieller Nachbar", adresse: "Nicht relevant", zusatz: "Wenn möglich, bitte nicht bei Nachbarn abgeben."} 
        ];


        for (let d = 0; d < sampleDistricts.length; d++) {
            const bezirk = sampleDistricts[d];
            for (let p = 0; p < sampleParts.length; p++) {
                const teil = sampleParts[p];
                const streets = sampleStreetData[bezirk][teil];
                for (let s = 0; s < streets.length; s++) {
                    const strasse = streets[s];
                    const itemsPerStreet = Math.floor(Math.random() * 3) + 2; 
                    let gangfolgeStreetCounter = 1;
                    for (let i = 0; i < itemsPerStreet; i++) {
                        if (generatedItems.length >= 60) break; 

                        const itemType = allItemTypes[Math.floor(Math.random() * allItemTypes.length)];
                        const lastName = sampleLastNames[Math.floor(Math.random() * sampleLastNames.length)];
                        const firstName = sampleFirstNames[Math.floor(Math.random() * sampleFirstNames.length)];
                        
                        let ablageort = "";
                        if (Math.random() > 0.4) { 
                            ablageort = sampleAblageorte[Math.floor(Math.random() * sampleAblageorte.length)];
                        }

                        let wunschnachbarObj = null; 
                        if (Math.random() > 0.6) { 
                            wunschnachbarObj = sampleWunschnachbarDetails[Math.floor(Math.random() * sampleWunschnachbarDetails.length)];
                        }
                        
                        generatedItems.push({
                            id: `00${itemIdCounter++}`,
                            bezirk: bezirk,
                            teil: teil,
                            strasse: strasse,
                            hausnummer: (Math.floor(Math.random() * 50) + 1) + (Math.random() > 0.8 ? ['a', 'b', 'c'][Math.floor(Math.random()*3)] : ''),
                            name: `${lastName}, ${firstName}`,
                            art: itemType,
                            gangfolgePosition: gangfolgeStreetCounter++,
                            ablageort: ablageort,
                            einzelWunschnachbar: wunschnachbarObj,
                            manualOrderIndex: null // Initialize manualOrderIndex
                        });
                    }
                    if (generatedItems.length >= 60) break;
                }
                if (generatedItems.length >= 60) break;
            }
            if (generatedItems.length >= 60) break;
        }
        
        const allItems = generatedItems;

        const packageTypes = ["Paket", "Kleinpaket", "Päckchen"];
        const registeredMailTypes = ["Einschreiben", "Einschreiben Einwurf", "Einschreiben Rückschein"];

        const houseIconSVG = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                <path d="M10 2.5l-8 5.6v9.4h5v-6h6v6h5v-9.4l-8-5.6zm0 2.1l6 4.2v7.2h-3v-6H7v6H4v-7.2l6-4.2z"/>
            </svg>`;
        const userIconSVG = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                <path d="M10 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm0-6c-1.103 0-2 .897-2 2s.897 2 2 2 2-.897 2-2-.897-2-2-2zm0 8c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4zm-6 4c.22-.72 2.31-2 6-2s5.78 1.28 6 2H4z"/>
            </svg>`;
        const dragHandleIconSVG = `
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
            </svg>`;

        const districts = [...new Set(allItems.map(item => item.bezirk))].sort();
        let currentDistrict = districts[0] || ""; 
        let priorityPart = "A"; 
        let activeFilterGroup = null; 
        let isReorderModeActive = false; // State for manual reorder mode
        let draggedItemElement = null; // To store the item being dragged

        const districtSelect = document.getElementById('districtSelect');
        const abSortButton = document.getElementById('abSortButton');
        const manualOrderButton = document.getElementById('manualOrderButton');
        const itemsListDiv = document.getElementById('itemsList');
     
